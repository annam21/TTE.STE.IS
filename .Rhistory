left_join(., count_at_occ, by = c("occ", "cam")) %>%
# Here NAs are pictures that didn't exist. 0s are counts of 0
# count should be NA if area = 0.
# Find the area until the first count, at each occasion
mutate(STE = cumsum(area))
head(tmp)%>%as.data.frame()
# Find sampling occasions where counts exist
# This captures any count within the occasion. Later, I take only the first
count_at_occ <- df %>%
filter(count > 0) %>%
left_join(effort, .,  by = "cam") %>%
filter(datetime %within% int) %>%
# Take only the first at each camera
filter(!duplicated(occ, cam)) %>%
select(occ, cam, count)
count_at_occ
??duplicated
# Find sampling occasions where counts exist
# This captures any count within the occasion. Later, I take only the first
count_at_occ <- df %>%
filter(count > 0) %>%
left_join(effort, .,  by = "cam") %>%
filter(datetime %within% int) %>%
# Take only the first at each camera
distinct(occ, cam) %>%
select(occ, cam, count)
# Find sampling occasions where counts exist
# This captures any count within the occasion. Later, I take only the first
count_at_occ <- df %>%
filter(count > 0) %>%
left_join(effort, .,  by = "cam") %>%
filter(datetime %within% int) %>%
# Take only the first at each camera
distinct(occ, cam, .keep_all = T) %>%
select(occ, cam, count)
count_at_occ
# Find sampling occasions where counts exist
# This captures any count within the occasion. Later, I take only the first
count_at_occ <- df %>%
filter(count > 0) %>%
left_join(effort, .,  by = "cam") %>%
filter(datetime %within% int) %>%
# Take only the first at each camera at each occasion
distinct(occ, cam, .keep_all = T) %>%
select(occ, cam, count)
count_at_occ
tmp <- effort %>%
# Randomly order cameras at each occasion
group_by(occ) %>%
sample_n(n()) %>%
# Join up our counts
left_join(., count_at_occ, by = c("occ", "cam")) %>%
# Here NAs are pictures that didn't exist. 0s are counts of 0
# count should be NA if area = 0.
# Find the area until the first count, at each occasion
mutate(STE = cumsum(area)) %>%
# If the area is 0, it's just adding 0 to the STE. That's good.
filter(count > 0) %>%
# Here I'm filtering NAs too, so if a photo doesn't exist, its count is 0
filter(!duplicated(occ)) %>%
# Add back NAs on all other sampling occasions
select(occ, STE) %>%
left_join(occ, ., by = "occ")
head(tmp)
tmp%>%filter(!is.na(STE))
# Do it with rounding instead of intervals!!!
count_at_occ <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
left_join(effort, ., by = c("start" = "nearestpos", "cam")) %>%
select(occ, cam, count)
# Do it with rounding instead of intervals!!!
count_at_occ
# Find sampling occasions where counts exist
# This captures any count within the occasion. Later, I take only the first
count_at_occ <- df %>%
filter(count > 0) %>%
left_join(effort, .,  by = "cam") %>%
filter(datetime %within% int) %>%
# Take only the first at each camera at each occasion
distinct(occ, cam, .keep_all = T) %>%
select(occ, cam, count)
# This captures any count within the occasion. Later, I take only the first
count_at_occ
df %>%
filter(count > 0)
df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
)
# Do it with rounding instead of intervals!!!
count_at_occ <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
left_join(effort, ., by = c("start" = "nearestpos", "cam")) %>%
select(occ, cam, count) %>%
distinct(occ, cam, .keep_all = T)
count_at_occ
# Do it with rounding instead of intervals!!!
count_at_occ <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
left_join(effort, ., by = c("start" = "nearestpos", "cam")) %>%
select(occ, cam, count) %>%
filter(!is.na(count))
count_at_occ
# Do it with rounding instead of intervals!!!
count_at_occ <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
left_join(effort, ., by = c("start" = "nearestpos", "cam")) %>%
select(occ, cam, count) %>%
filter(!is.na(count)) %>%
distinct(occ, cam, .keep_all = T)
count_at_occ
df %>%
filter(count > 0) %>%
left_join(effort, .,  by = "cam")
df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
)
count_at_occ <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
left_join(., effort, by = c("start" = "nearestpos", "cam"))
count_at_occ <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
left_join(., effort, by = c("nearestpos" = "start", "cam"))
count_at_occ
count_at_occ <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
left_join(., effort, by = c("nearestpos" = "start", "cam")) %>%
select(occ, cam, count)
count_at_occ
# Do it with rounding instead of intervals!!!
count_at_occ <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
left_join(., effort, by = c("nearestpos" = "start", "cam")) %>%
select(occ, cam, count) %>%
distinct(occ, cam, .keep_all = T)
count_at_occ
count_at_occ <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
left_join(., effort, by = c("nearestpos" = "start", "cam"))
head(count_at_occ)
head(effort)
tz(effort$start)
lubridate:;tz(effort$start)
lubridate::tz(effort$start)
count_at_occ <- df %>%
filter(count > 0)
head(count_at_occ)
xx <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
)
head(xx)
ss
xx$nearestpos+40000
xx$nearestpos[1]+40000
head(xx)
head(occ)
occ
xx <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
left_join(., effort, by = c("nearestpos" = "start", "cam"))
head(xx)
xx <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
# Join by the start time of that interval
left_join(., effort, by = c("nearestpos" = "start", "cam")) %>%
# But then keep only if within the end date of that interval
filter(datetime <= end)
xx
xx <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
# Join by the start time of that interval
left_join(., effort, by = c("nearestpos" = "start", "cam")) %>%
# But then keep only if within the end date of that interval
filter(datetime <= end) %>%
select(occ, cam, count)
xx
# Do it with rounding instead of intervals!!!
xx <- df %>%
filter(count > 0) %>%
# round down to the nearest interval
mutate(timefromfirst = as.numeric(datetime) - as.numeric(min(effort$start)),
nearest = plyr::round_any(timefromfirst, ss, f = floor),
nearestpos = as.POSIXct(nearest,
origin = min(effort$start),
tz = lubridate::tz(effort$start))
) %>%
# Join by the start time of that interval
left_join(., effort, by = c("nearestpos" = "start", "cam")) %>%
# But then keep only if within the end date of that interval
filter(datetime <= end) %>%
select(occ, cam, count) %>%
# Only keep the first one at each camera on each occasion
distinct(occ, cam, .keep_all = T)
xx
# Find sampling occasions where counts exist
# This captures any count within the occasion. Later, I take only the first
count_at_occ <- df %>%
filter(count > 0) %>%
left_join(effort, .,  by = "cam") %>%
filter(datetime %within% int) %>%
# Take only the first at each camera at each occasion
distinct(occ, cam, .keep_all = T) %>%
select(occ, cam, count)
count_at_occ
library(tidyverse)
devtools::load_all(".")
load("../CameraTrapStudy/2015 data/pics.wide20160804.RData")
# Make dataframe
df <- pics %>%
select(cam, timeGMT, elkpresent) %>%
filter(elkpresent == T) %>%
mutate(count = as.numeric(elkpresent)
) %>%
rename(datetime = timeGMT)
# Make a pretend deploy, as if all always working
deploy <- pics %>%
distinct(cam, op.start, op.end) %>%
# fix problem child
mutate(op.start = replace(op.start, cam == "AM158", "2016-01-05 17:00:00") ) %>%
mutate(start = as.POSIXct(op.start),
start = lubridate::force_tz(start, "GMT"),
end = as.POSIXct(op.end),
end = lubridate::force_tz(end, "GMT"),
area = 250
) %>%
select(-op.start, -op.end)
study_dates <- as.POSIXct(c("2016-01-01 01:04:18", "2016-03-27 00:00:00"),
tz = "GMT")
# Now actually use the package
occ <- build_occ(samp_freq = 40000,
samp_length = 1,
study_start = study_dates[1],
study_end = study_dates[2])
ste_eh <- ste_build_eh(df, deploy, occ)
# Now actually use the package
occ <- build_occ(samp_freq = 30,
samp_length = 1,
study_start = study_dates[1],
study_end = study_dates[2])
ste_eh <- ste_build_eh(df, deploy, occ)
# Fail if a camera took a photo but that time is not in deploy
# Very similar function to find_overlap. Work on that in future
pic_in_deploy <- left_join(df, deploy) %>%
mutate(wthn = datetime >= start & datetime <= end) %>%
group_by(cam) %>%
summarise(allgood = any(wthn)) %>%
filter(allgood == F | is.na(allgood))
head(df)
head(deploy)
# Now actually use the package
occ <- build_occ(samp_freq = 4000,
samp_length = 1,
study_start = study_dates[1],
study_end = study_dates[2])
devtools::load_all(".")
ste_eh <- ste_build_eh(df, deploy, occ)
devtools::load_all(".")
?spaceNtime
?dplyr
devtools::load_all(".")
?spaceNtime
devtools::load_all(".")
?spaceNtime
?ggplot2
package?ggplot2
devtools::load_all(".")
?spaceNtime
devtools::load_all(".")
?spaceNtime
devtools::load_all(".")
?spaceNtime
devtools::load_all(".")
?spaceNtime
?plot_crayons
??plot_crayons
devtools::load_all(".")
?spaceNtime
browseVignettes("spaceNtime")
?browseVignettes
browseVignettes("spaceNtime")
devtools::load_all(".")
?spaceNtime
source('~/GitHub/spaceNtime/R/spaceNtime-package.R')
devtools::load_all(".")
?spaceNtime
devtools::load_all(".")
?spaceNtime
usethis::use_package_doc()
usethis::use_package_doc()
devtools::load_all(".")
?spaceNtime
package?spaceNtime
devtools::load_all(".")
?spaceNtime
devtools::load_all(".")
?spaceNtime
package?spaceNtime
devtools::load_all(".")
?spaceNtime
devtools::load_all(".")
?spaceNtime
?camtrapR
??camtrapR
devtools::load_all(".")
?spaceNtime
package?camtrapR
help("package:camtrapR")
install.packages("camtrapR")
help("package:camtrapR")
?camtrapR
package?camtrapR
devtools::load_all(".")
?spaceNtime
devtools::load_all(".")
?spaceNtime
devtools::load_all(".")
?spaceNtime
devtools::load_all(".")
?spaceNtime
install.packages("roxygen2")
devtools::load_all(".")
?spaceNtime
?spaceNtime
install.packages("devtools")
install.packages("devtools")
library(roxygen2)
devtools::load_all(".")
?spaceNtime
devtools::load_all(".")
?spaceNtime
devtools::install_github("annam21/spaceNtime@1.1.2", build_opts = c("--no-resave-data", "--no-manual"), force = T, build_vignettes = T)
devtools::install_github("annam21/spaceNtime@1.1.2", build_opts = c("--no-resave-data", "--no-manual"), force = T, build_vignettes = T)
?spaceNtime
??spaceNtime
browseVignettes("spaceNtime")
df <- data.frame(
cam = c(1,1,2,2,2),
datetime = as.POSIXct(c("2016-01-02 12:00:00",
"2016-01-03 13:12:00",
"2016-01-02 12:00:00",
"2016-01-02 14:00:00",
"2016-01-03 16:53:42"),
tz = "GMT"),
count = c(1, 0, 0, 1, 2)
)
deploy <- data.frame(
cam = c(1, 2, 2, 2),
start = as.POSIXct(c("2015-12-01 15:00:00",
"2015-12-08 00:00:00",
"2016-01-01 00:00:00",
"2016-01-02 00:00:00"),
tz = "GMT"),
end = as.POSIXct(c("2016-01-05 00:00:00",
"2015-12-19 03:30:00",
"2016-01-01 05:00:00",
"2016-01-05 00:00:00"),
tz = "GMT"),
area = c(300, 200, 200, 450)
)
study_dates <- as.POSIXct(c("2016-01-01 00:00:00", "2016-01-04 23:59:59"), tz = "GMT")
occ <- build_occ(samp_freq = 3600, # seconds between the start of each sampling occasion
samp_length = 10, # duration of each sampling occasion (seconds)
study_start = study_dates[1],
study_end = study_dates[2])
require(spaceNtime)
occ <- build_occ(samp_freq = 3600, # seconds between the start of each sampling occasion
samp_length = 10, # duration of each sampling occasion (seconds)
study_start = study_dates[1],
study_end = study_dates[2])
ste_eh <- ste_build_eh(df, deploy, occ)
head(ste_eh)
df
?ste_build_eh
?tictoc::toc
tictoc::tic()
tictoc::toc()
?n()
?pexp
lambda <- 0.00001
n_occ <- 10000
n_bins <- 10
censor <- 500
require(dplyr); require(spaceNtime); require(purrr)
data <- tibble(to_event = rexp(n_occ, lambda)) %>%
mutate(to_event = replace(to_event, to_event > censor, NA))
exp_dens <- function(left, right, lambda){
pleft <- pexp(left, lambda); pright <- pexp(right, lambda)
out <- pright - pleft
return(out)
}
build_bins <- function(n_bins, censor, lambda){
cutoffs <- seq(0, censor, length.out = n_bins)
bin_data <- tibble(
bin = 1:n_bins,
left = cutoffs,
right = lead(cutoffs),
prob = exp_dens(left, right, lambda)
) %>%
mutate(prob = tidyr::replace_na(prob, replace = 1-sum(prob, na.rm = T)))
}
assign_bins <- function(x, bin_data, to_event){
out <- between(to_event, bin_data$left[x], bin_data$right[x])
}
tictoc::tic
?invisible
x <- tictoc::tic()
x
x
head(ste_eh)
?ste_estN_fn
?tte_estN_fn
